<!--è¿½åŠ ãƒ»å¤‰æ›´é …ç›®
ãƒ»ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’æ–°èª¿
ãƒ»åå‰ã‚’å…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸ-->


<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ç½°é‡‘è¨ˆç®—æ©Ÿï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{ --gap:8px; --btn-radius:20px; --accent:#c00; --card-bg:#f7f7f7; --muted:#666; }
    body{font-family:Arial,Helvetica,sans-serif;padding:20px;background:#fff}
    .title-container{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    h1{margin:0;font-size:1.4rem}
    .title-note{color:var(--accent);font-weight:700;font-size:0.95rem}
    .controls{display:flex;flex-wrap:wrap;gap:var(--gap);margin-bottom:12px}
    .crime-btn{padding:8px 16px;border-radius:var(--btn-radius);border:1px solid #ddd;background:#fff;cursor:pointer}
    .crime-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    #options{display:none;margin-top:12px;background:var(--card-bg);padding:12px;border-radius:8px;border:1px solid #e0e0e0}
    fieldset{margin:10px 0;padding:10px;border:1px solid #ccc}
    legend{font-weight:700}
    .row{display:flex;align-items:center;gap:8px;margin:6px 0;flex-wrap:wrap;justify-content:space-between}
    .row-left{display:flex;align-items:center;gap:8px;min-width:0}
    .row-right{display:flex;align-items:center;gap:12px;white-space:nowrap;margin-left:12px}
    label{cursor:pointer;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    input[type=number]{width:68px;padding:4px}
    #result{margin-top:12px;padding:10px;border:1px solid #ccc;background:#fafafa}
    .muted{color:var(--muted);font-size:0.9rem}
    .meta{display:flex;align-items:center;color:var(--muted);font-size:0.9rem;min-width:160px;justify-content:flex-end}
    .amount{font-weight:700;font-family:Menlo,Monaco,Consolas,"Courier New",monospace;color:#000}
    .time{color:#444;margin-left:8px;font-size:0.9rem}
    .count-input{margin-left:6px}
    .right{margin-left:auto}
    button.small{padding:6px 10px;border-radius:6px;margin-right:6px}
    #personsContainer{margin-top:10px;border-top:1px solid #e5e5e5;padding-top:8px}
    .person-row{display:flex;align-items:center;gap:8px;margin:6px 0}
    .person-name{min-width:120px}
    .person-remove{background:#eee;border:1px solid #ccc;padding:4px 6px;border-radius:6px;cursor:pointer}
    @media (max-width:480px){
      .controls{gap:6px}.crime-btn{padding:6px 10px}
      .meta{font-size:0.85rem;min-width:120px}
      .row{flex-wrap:wrap}
      .row-right{margin-top:6px}
      .person-name{min-width:80px}
    }
  </style>
</head>
<body>
  <div class="title-container">
    <h1>ç½°é‡‘è¨ˆç®—æ©Ÿ</h1>
    <span class="title-note">â€»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ®ºäººç½ªã¯å¤§å‹ã‹ã‚‰ãƒã‚§ãƒƒã‚¯æ¸ˆã¿</span>
  </div>

  <div class="controls" id="crimeButtons" aria-label="çŠ¯ç½ªä¸€è¦§"></div>

  <div id="options" aria-live="polite">
    <div>
      <label><input type="checkbox" id="bailOption"> ä¿é‡ˆé‡‘æ”¯æ‰•ã„ï¼ˆç½°é‡‘ã®2å€ï¼‰<span class="muted">â€»è»½çŠ¯ç½ªã®ã¿é©ç”¨</span></label>
    </div>

    <div id="personsContainer">
      <div style="display:flex;gap:8px;align-items:center">
        <input type="text" id="personNameInput" placeholder="åå‰ã‚’å…¥åŠ›" style="flex:1;padding:6px">
        <button id="addPersonBtn" class="crime-btn" type="button">è¿½åŠ </button>
      </div>
      <div id="personsList" aria-live="polite"></div>
      <div class="muted" style="font-size:0.85rem;margin-top:6px">è¤‡æ•°è¿½åŠ ã§ãã¾ã™ã€‚å„äººã®ã€Œè–¬Ã—ã€ã¯ã‚³ãƒ”ãƒ¼æ™‚ã«åå‰æ¨ªã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
    </div>

    <div id="generatedOptions"><!-- JS ã§ç”Ÿæˆã•ã‚Œã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ --></div>

    <div style="margin-top:10px">
      <button id="calcBtn" class="crime-btn">è¨ˆç®—ã™ã‚‹</button>
      <button id="resetBtn" class="crime-btn">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

  <div id="result" aria-live="polite"></div>

<script>
/* ãƒ‡ãƒ¼ã‚¿å®šç¾© */
const DATA = {
  crimes: [
    "å®¶å¼·ç›—","ATMå¼·ç›—","ã‚³ãƒ³ãƒ“ãƒ‹å¼·ç›—","ãƒ•ãƒªãƒ¼ã‚«éŠ€è¡Œå¼·ç›—","å®çŸ³å¼·ç›—","è»äº‹ç‰©è³‡å¼·ç›—",
    "ãƒ‘ãƒ¬ãƒˆéŠ€è¡Œå¼·ç›—","å®¢èˆ¹å¼·ç›—","ãƒœãƒ–ã‚­ãƒ£ãƒƒãƒˆ","é£›è¡Œå ´è¥²æ’ƒ","ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆå¼·ç›—",
    "ãƒ¦ãƒ‹ã‚ªãƒ³éŠ€è¡Œå¼·ç›—","ãƒ‘ã‚·ãƒ•ã‚£ãƒƒã‚¯éŠ€è¡Œå¼·ç›—","ãƒ•ã‚¡ã‚¹ãƒˆãƒ˜ã‚¤ã‚¹ãƒˆ","å€‹äººåŒ»","ãã®ä»–"
  ],
  fixedTimeByCrime: {
    "å®¶å¼·ç›—":20,"ATMå¼·ç›—":20,"ã‚³ãƒ³ãƒ“ãƒ‹å¼·ç›—":20,"ãƒ•ãƒªãƒ¼ã‚«éŠ€è¡Œå¼·ç›—":30,"å®çŸ³å¼·ç›—":30,
    "è»äº‹ç‰©è³‡å¼·ç›—":30,"ãƒ‘ãƒ¬ãƒˆéŠ€è¡Œå¼·ç›—":40,"å®¢èˆ¹å¼·ç›—":40,"ãƒœãƒ–ã‚­ãƒ£ãƒƒãƒˆ":40,
    "é£›è¡Œå ´è¥²æ’ƒ":60,"ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆå¼·ç›—":60,"ãƒ¦ãƒ‹ã‚ªãƒ³éŠ€è¡Œå¼·ç›—":60,
    "ãƒ‘ã‚·ãƒ•ã‚£ãƒƒã‚¯éŠ€è¡Œå¼·ç›—":60,"ãƒ•ã‚¡ã‚¹ãƒˆãƒ˜ã‚¤ã‚¹ãƒˆ":60,"å€‹äººåŒ»":30
  },
  charges: [
    { id:"gunLaw", label:"éŠƒåˆ€æ³•é•å", fine:100000, time:10, group:"petty" },
    { id:"theft", label:"è»½çªƒç›—ç½ª", fine:300000, time:10, group:"petty" },
    { id:"pettyRobberyAttempt", label:"è»½å¼·ç›—æœªé‚", fine:150000, time:0, group:"petty" },
    { id:"pettyRobbery", label:"è»½å¼·ç›—ç½ª", fine:300000, time:0, group:"petty" },
    { id:"fraud", label:"è©æ¬ºç½ª", fine:500000, time:10, group:"petty" },
    { id:"obstructionOfficialDuties", label:"å…¬å‹™åŸ·è¡Œå¦¨å®³", fine:100000, time:10, group:"petty" },
    { id:"assault", label:"æš´è¡Œç½ª", fine:200000, time:10, group:"petty" },
    { id:"noId", label:"IDãƒ»ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ä¸æºå¸¯", fine:100000, time:0, group:"petty" },

    { id:"aggravatedTheft", label:"é‡çªƒç›—ç½ªï¼ˆå…¬å‹™å“¡è»Šä¸¡ï¼‰", fine:3000000, time:30, group:"heavy" },
    { id:"aggravatedRobberyAttempt", label:"æº–é‡å¼·ç›—æœªé‚", fine:500000, time:0, group:"heavy" },
    { id:"aggravatedRobbery", label:"æº–é‡å¼·ç›—ç½ª", fine:1000000, time:0, group:"heavy" },
    { id:"armedRobberyAttempt", label:"é‡å¼·ç›—æœªé‚", fine:3000000, time:0, group:"heavy" },
    { id:"armedRobbery", label:"é‡å¼·ç›—ç½ª", fine:6000000, time:0, group:"heavy" },
    { id:"firstDegreeRobberyAttempt", label:"æœ€é‡å¼·ç›—æœªé‚", fine:7000000, time:0, group:"heavy" },
    { id:"firstDegreeRobbery", label:"æœ€é‡å¼·ç›—ç½ª", fine:14000000, time:0, group:"heavy" },
    { id:"kidnap", label:"èª˜æ‹ãƒ»æ‹‰è‡´ãƒ»ç›£ç¦ç½ª", fine:100000, time:10, group:"heavy" },
    { id:"npcMurder", label:"NPCæ®ºäººç½ª", fine:100000, time:10, group:"heavy" },
    { id:"attemptedMurder", label:"æ®ºäººæœªé‚", fine:1000000, time:20, group:"heavy" },
    { id:"playerMurder", label:"ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ®ºäººç½ª", fine:1500000, time:30, group:"heavy" },
    { id:"prisonEscape", label:"è„±ç„ç½ª", fine:1000000, time:60, group:"heavy" },
    { id:"aidingEscape", label:"é€ƒèµ°è£œåŠ©ç½ª", fine:2000000, time:30, group:"heavy" },
    { id:"facilityAttack", label:"å…¬å…±æ–½è¨­è¥²æ’ƒç½ª", fine:50000000, time:60, group:"heavy" },
    { id:"PoliceStationAssault", label:"è­¦å¯Ÿç½²è¥²æ’ƒç½ª", fine:30000000, time:60, group:"heavy" },
    { id:"eventTerrorism", label:"ã‚¤ãƒ™ãƒ³ãƒˆãƒ†ãƒ­ç½ª", fine:100000000, time:60, group:"heavy" },
    { id:"sexualHarassment", label:"ã‚»ã‚¯ãƒãƒ©ç½ª", fine:100000000, time:60, group:"heavy" },
    { id:"bribery", label:"åè³„ç½ª", fine:300000000, time:60, group:"heavy" },
    { id:"businessObstruction", label:"æ¥­å‹™å¦¨å®³ç½ª", fine:5000000, time:60, group:"heavy" },

    { id:"illegalDrugHarvesting", label:"é•æ³•è–¬ç‰©æ¡å–", fine:500000, time:10, group:"drug" },
    { id:"illegalRawDrug", label:"é•æ³•è–¬ç‰©åŸææ–™æ‰€æŒï¼ˆ1å€‹ 1ä¸‡ï¼‰", finePerUnit:10000, time:20, group:"drug", hasCount:true, max:999 },
    { id:"illegalDrugUnit", label:"é•æ³•è–¬ç‰©æ‰€æŒï¼ˆ1å€‹ 2ä¸‡ï¼‰", finePerUnit:20000, time:20, group:"drug", hasCount:true, max:999 },
    { id:"illegalDrugFlat", label:"é•æ³•è–¬ç‰©å£²è²·", fine:200000, time:20, group:"drug" }
  ],
  crimeMappings: {
    "å®¶å¼·ç›—":["pettyRobbery","obstructionOfficialDuties"],
    "ATMå¼·ç›—":["pettyRobbery","obstructionOfficialDuties"],
    "ã‚³ãƒ³ãƒ“ãƒ‹å¼·ç›—":["pettyRobbery","gunLaw","obstructionOfficialDuties","kidnap","npcMurder"],
    "ãƒ•ãƒªãƒ¼ã‚«éŠ€è¡Œå¼·ç›—":["aggravatedRobbery","gunLaw","obstructionOfficialDuties","kidnap"],
    "å®çŸ³å¼·ç›—":["aggravatedRobbery","gunLaw","obstructionOfficialDuties","kidnap"],
    "è»äº‹ç‰©è³‡å¼·ç›—":["aggravatedRobbery","gunLaw","obstructionOfficialDuties","npcMurder"],
    "ãƒ‘ãƒ¬ãƒˆéŠ€è¡Œå¼·ç›—":["armedRobbery","gunLaw","obstructionOfficialDuties","playerMurder"],
    "å®¢èˆ¹å¼·ç›—":["armedRobbery","gunLaw","obstructionOfficialDuties","npcMurder","playerMurder"],
    "ãƒœãƒ–ã‚­ãƒ£ãƒƒãƒˆ":["armedRobbery","gunLaw","obstructionOfficialDuties","npcMurder","playerMurder"],
    "é£›è¡Œå ´è¥²æ’ƒ":["firstDegreeRobbery","gunLaw","npcMurder","obstructionOfficialDuties","playerMurder"],
    "ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆå¼·ç›—":["firstDegreeRobbery","gunLaw","obstructionOfficialDuties","npcMurder","playerMurder"],
    "ãƒ¦ãƒ‹ã‚ªãƒ³éŠ€è¡Œå¼·ç›—":["firstDegreeRobbery","gunLaw","obstructionOfficialDuties","playerMurder"],
    "ãƒ‘ã‚·ãƒ•ã‚£ãƒƒã‚¯éŠ€è¡Œå¼·ç›—":["firstDegreeRobbery","gunLaw","obstructionOfficialDuties","playerMurder"],
    "ãƒ•ã‚¡ã‚¹ãƒˆãƒ˜ã‚¤ã‚¹ãƒˆ":["firstDegreeRobbery","gunLaw","obstructionOfficialDuties","playerMurder"],
    "å€‹äººåŒ»":["aidingEscape","obstructionOfficialDuties"]
  }
};

/* ãƒ˜ãƒ«ãƒ‘ãƒ¼ */
function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==='class') e.className = v;
    else if(k==='html') e.innerHTML = v;
    else e.setAttribute(k,v);
  });

  children.forEach(c=>{ if(c!=null) e.append(typeof c==='string'?document.createTextNode(c):c); });
  return e;
}

/* participants */
const participants = []; // {id, name, drugCount}

/* participantsâ†’ç”Ÿæˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ï¼ˆåå‰å´ã®è–¬æ•°ã‚’ä¸‹ã®é•æ³•è–¬ç‰©æ‰€æŒã«åæ˜ ï¼‰ */
function updateGlobalDrugTotals(){
  const total = participants.reduce((s,p) => s + (p.drugCount || 0), 0);
  const unitCb = document.getElementById('illegalDrugUnit');
  const unitCount = document.getElementById('illegalDrugUnit_count');
  if(!unitCb || !unitCount) return;

  // åå‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ã€åå‰åˆè¨ˆã‚’åæ˜ ï¼ˆåå‰å„ªå…ˆï¼‰
  if(participants.length > 0){
    if(total > 0){
      unitCb.checked = true;
      unitCount.value = total;
      unitCount.style.display = 'inline-block';
    } else {
      // åå‰ã«è–¬æ•°ãŒç„¡ã„å ´åˆã¯UIã‚’ãƒªã‚»ãƒƒãƒˆ
      unitCb.checked = false;
      unitCount.style.display = 'none';
    }
  } else {
    // åå‰ãŒç„¡ã„å ´åˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’ä¿æŒï¼ˆä¸Šæ›¸ãã—ãªã„ï¼‰
    // ã“ã“ã§ã¯ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã«å¿œã˜ã¦è¦‹ãŸç›®ã ã‘æ›´æ–°
    unitCount.style.display = unitCb.checked ? 'inline-block' : 'none';
    // unitCount.value ã¯å¤‰æ›´ã—ãªã„ï¼ï¼
  }
}

/* UI ã®ç”Ÿæˆ */
function buildUI(){
  const btnContainer = document.getElementById('crimeButtons');
  btnContainer.innerHTML = '';
  DATA.crimes.forEach(name=>{
    const b = el('button',{class:'crime-btn',type:'button'});
    b.textContent = name;
    b.addEventListener('click',()=> selectCrime(name,b));
    btnContainer.appendChild(b);
  });

  const gen = document.getElementById('generatedOptions');
  if(!gen) return;
  gen.innerHTML = '';

  const groups = {petty:[], heavy:[], drug:[]};
  DATA.charges.forEach(ch=> groups[ch.group||'petty'].push(ch));

  Object.entries(groups).forEach(([groupName, list])=>{
    const fs = el('fieldset',{}, el('legend',{}, groupName === 'petty' ? 'è»½çŠ¯ç½ª' : groupName === 'heavy' ? 'é‡çŠ¯ç½ª' : 'è–¬'));
    list.forEach(ch=>{
      const row = el('div',{class:'row'});
      const checkbox = el('input',{type:'checkbox',id:ch.id});
      const label = el('label',{'for':ch.id}, `${ch.label}` );
      const left = el('div',{class:'row-left'});
      left.appendChild(checkbox);
      left.appendChild(label);

    if(ch.hasCount){
  // drugã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆé•æ³•è–¬ç‰©ãƒ»åŸææ–™ãªã©ï¼‰ã¯1äººã‚ãŸã‚Šæœ€å¤§100ã¾ã§
  const maxVal = (ch.group === 'drug') ? 100 : (ch.max || 999);
  const num = el('input',{
    type:'number',
    id: ch.id + '_count',
    value:0,
    min:0,
    max: maxVal,
    class:'count-input',
    style:'display:none;margin-left:6px'
  });

  // ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚ŒãŸã¨ãã ã‘æ•°å€¤å…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤º
  checkbox.addEventListener('change',()=> num.style.display = checkbox.checked ? 'inline-block' : 'none');

  // å…¥åŠ›å€¤ã‚’å¸¸ã«0ã€œmaxValã®ç¯„å›²ã«åã‚ã‚‹ï¼ˆ100è¶…ãˆé˜²æ­¢ï¼‰
  num.addEventListener('input', (e) => {
    let v = parseInt(e.target.value, 10);
    if (Number.isNaN(v)) v = 0;
    if (v < 0) v = 0;
    if (v > maxVal) v = maxVal;
    if (String(e.target.value) !== String(v)) {
      e.target.value = v;
    }
  });

  left.appendChild(num);
}
      row.appendChild(left);

      const right = el('div',{class:'row-right'});
      const amountText = ch.hasCount ? (ch.finePerUnit || 0) : (ch.fine || 0);
      const amount = el('span',{class:'meta'}, '');
      const amtSpan = el('span',{class:'amount'}, amountText.toLocaleString() + ' å††');
      const timeSpan = el('span',{class:'time'}, (ch.time || 0) + ' åˆ†');
      amount.appendChild(amtSpan);
      amount.appendChild(timeSpan);
      right.appendChild(amount);
      row.appendChild(right);

      fs.appendChild(row);
    });
    gen.appendChild(fs);
  });
}

/* participants UI helpers */
function renderParticipants(){
  const list = document.getElementById('personsList');
  if(!list) return;
  list.innerHTML = '';
  participants.forEach(p=>{
    const row = el('div',{class:'person-row', 'data-id':p.id});
    const nameSpan = el('span',{class:'person-name'}, p.name);

    const drugLabel = el('label',{}, `ï¼ˆè–¬Ã—`);
    const drugInput = el('input',{
      type:'number',
      value:p.drugCount,
      min:0,
      max:100, // å„äºº100å€‹ã¾ã§
      style:'width:72px',
      id:`person_${p.id}_drug`
    });

    drugInput.addEventListener('change', (e)=> {
      let val = parseInt(e.target.value,10) || 0;
      if (val > 100) {
        val = 100;
        e.target.value = 100;
      }
      p.drugCount = val;
      updateGlobalDrugTotals();
    });

    const drugClose = el('span',{}, 'å€‹ï¼‰');
    const removeBtn = el('button',{class:'person-remove',type:'button'}, 'å‰Šé™¤');
    removeBtn.addEventListener('click', ()=> {
      const idx = participants.findIndex(x=>x.id===p.id);
      if(idx>-1) participants.splice(idx,1);
      renderParticipants();
      updateGlobalDrugTotals();
    });

    row.appendChild(nameSpan);
    row.appendChild(drugLabel);
    row.appendChild(drugInput);
    row.appendChild(drugClose);
    row.appendChild(removeBtn);
    list.appendChild(row);
  });

  // è¡¨ç¤ºæ›´æ–°å¾Œã«åˆè¨ˆã‚’ç”Ÿæˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«åæ˜ 
  updateGlobalDrugTotals();
}
/* é¸æŠãƒ»è¡¨ç¤ºåˆ¶å¾¡ */
let selectedCrime = null;
function selectCrime(name, btn){
  const optionsDiv = document.getElementById('options');
  const allButtons = document.querySelectorAll('.crime-btn');
  if(selectedCrime === name && optionsDiv.style.display === 'block'){
    optionsDiv.style.display = 'none';
    document.getElementById('result').innerText = '';
    allButtons.forEach(b=>b.classList.remove('active'));
    selectedCrime = null;
    return;
  }
  selectedCrime = name;
  allButtons.forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('result').innerText = '';
  optionsDiv.style.display = 'block';

  document.querySelectorAll('#generatedOptions input[type=checkbox]').forEach(cb=>cb.checked=false);
  document.querySelectorAll('#generatedOptions input[type=number]').forEach(n=>{ n.value=0; n.style.display='none'; });

  const map = DATA.crimeMappings[name];
  if(map){
    map.forEach(id=>{
      const elm = document.getElementById(id);
      if(elm) elm.checked = true;
      const c = document.getElementById(id + '_count');
      if(c) c.style.display = elm && elm.checked ? 'inline-block' : 'none';
    });
  }
  updateBailAvailability();
}

/* ä¿é‡ˆåˆ¤å®š */
function updateBailAvailability(){
  const bailEl = document.getElementById('bailOption');
  if(!bailEl) return;
  const heavyIds = DATA.charges.filter(c=>c.group==='heavy').map(c=>c.id);
  const heavyChecked = heavyIds.some(id => {
    const el = document.getElementById(id);
    return el && el.checked;
  });
  const existingWarn = document.getElementById('bailWarning');
  if(heavyChecked){
    bailEl.checked = false;
    bailEl.disabled = true;
    if(!existingWarn){
      const warn = el('div',{id:'bailWarning',style:'color:var(--accent)'}, 'â€»ä¿é‡ˆé‡‘ã¯è»½çŠ¯ç½ªã«ã—ã‹é©ç”¨ã§ãã¾ã›ã‚“ã€‚');
      bailEl.parentElement.appendChild(warn);
    }
  } else {
    bailEl.disabled = false;
    if(existingWarn) existingWarn.remove();
  }
}

/* è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ */
function calculateFine(){
  // å…¥åŠ›ä¸­ã®åå‰ã‚’è¨ˆç®—æ™‚ã«è‡ªå‹•è¿½åŠ ï¼ˆé‡è¤‡ã¯é˜²æ­¢ï¼‰
  const nameInput = document.getElementById('personNameInput');
  const typedName = nameInput?.value?.trim();
  if(typedName){
    const exists = participants.some(p => p.name === typedName);
    if(!exists){
      const id = Date.now().toString(36) + Math.random().toString(36).slice(2,6);
      participants.push({ id, name: typedName, drugCount: 0 });
      renderParticipants();
    }
    nameInput.value = '';
  }

  // ç”Ÿæˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨æ•´åˆã•ã›ã‚‹
  updateGlobalDrugTotals();
  updateBailAvailability();

  // åŸºæœ¬é›†è¨ˆ
  let totalBeforeBail = 0; // å…¨ç½°é‡‘ï¼ˆä¿é‡ˆå‰ãƒ»åŒ…æ‹¬è–¬ç‰©ï¼‰
  let time = 0;
  const selected = [];
  const breakdown = {petty: {fine:0, time:0}, heavy:{fine:0,time:0}, drug:{fine:0,time:0}};

  const isManual = selectedCrime === 'ãã®ä»–';
  if(!isManual && DATA.fixedTimeByCrime[selectedCrime]) time = DATA.fixedTimeByCrime[selectedCrime];

  // å…ˆã«å–å¾—ã—ã¦ãŠãï¼šå‚åŠ è€…ã®è–¬åˆè¨ˆ
  const personRows = Array.from(document.querySelectorAll('.person-row'));
  const people = participants.length ? participants.slice() : personRows.map(r => {
    const id = r.getAttribute('data-id') || '';
    const name = r.querySelector('.person-name')?.textContent?.trim() || 'ï¼ˆç„¡åï¼‰';
    const drugInput = r.querySelector('input[id^="person_"]');
    const drugCount = drugInput ? (parseInt(drugInput.value, 10) || 0) : 0;
    return { id, name, drugCount };
  });
  const participantsDrugTotal = people.reduce((s,p)=> s + (p.drugCount||0), 0);

 DATA.charges.forEach(ch=>{
  const cb = document.getElementById(ch.id);
  if(!cb || !cb.checked) return;

  if(ch.hasCount){
    // ç”Ÿæˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆä¸‹ã®æ•°å€¤å…¥åŠ›ï¼‰ã‹ã‚‰ã®è–¬åˆ†ã®åŠ ç®—ã¯ã€
    // åå‰ä»˜ãå‚åŠ è€…ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯äºŒé‡ã‚«ã‚¦ãƒ³ãƒˆã«ãªã‚‹ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
    if(ch.group === 'drug' && people.length > 0){
      // å‚åŠ è€…å´ã® drugCount ã‚’ä½¿ã£ã¦å€‹åˆ¥ã«èª²é‡‘ã™ã‚‹ãŸã‚ã“ã“ã§ã¯ç„¡è¦–
      // ãŸã ã—ã€å‚åŠ è€…ãŒã„ãªã„ï¼ˆåŒ¿åé‹ç”¨ï¼‰ãªã‚‰ä¸‹ã®æ•°å€¤ã‚’ä½¿ã£ã¦åŠ ç®—ã™ã‚‹
      // ï¼ˆå‡¦ç†ã‚’æŠœã‘ã‚‹ã ã‘ï¼‰
      return;
    }

    const cnt = parseInt(document.getElementById(ch.id + '_count')?.value,10) || 0;
    const add = (ch.finePerUnit || 0) * cnt;
    totalBeforeBail += add;
    breakdown[ch.group].fine += add;
    breakdown[ch.group].time += ch.time || 0;
    if(ch.group === 'drug') breakdown.drug.fine += add;
    if(isManual) time += ch.time || 0;

    // è–¬ã®å€‹æ•°è¡¨ç¤ºã¯é›†è¨ˆè¡¨ç¤ºã«ã—ãŸã„ã®ã§å€‹åˆ¥è¡Œã¯è¿½åŠ ã—ãªã„
  } else {
    const add = ch.fine || 0;
    totalBeforeBail += add;
    breakdown[ch.group].fine += add;
    breakdown[ch.group].time += ch.time || 0;
    if(isManual) time += ch.time || 0;
    selected.push(ch.label);
  }
});



  // ã€Œé•æ³•è–¬ç‰©æ‰€æŒï¼ˆã€‡å€‹ï¼‰â€»ç·æ•°ã€ã‚’è¿½åŠ ï¼ˆç·æ•°ãŒ0ãªã‚‰è¡¨ç¤ºã—ãªã„ï¼‰
  if(participantsDrugTotal > 0){
    selected.push(`é•æ³•è–¬ç‰©æ‰€æŒï¼ˆ${participantsDrugTotal}å€‹ï¼‰â€»ç·æ•°`);
  }

  /// --- çµ±åˆç‰ˆï¼ˆã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã§ drugUnitFinePer ã‚’ä¸€åº¦ã ã‘å®£è¨€ï¼‰ ---
// éè–¬ç‰©éƒ¨åˆ†ï¼ˆå‚åŠ è€…è–¬ã¯ participantsDrugTotal ã‚’åŸºã«ç®—å‡ºï¼‰
const drugUnitFinePer = 20000; // illegalDrugUnit ã®å˜ä¾¡ï¼ˆã“ã“ã§ä¸€åº¦ã ã‘å®£è¨€ï¼‰
const participantsDrugFine = participantsDrugTotal * drugUnitFinePer;
const nonDrugBeforeBail = totalBeforeBail;
// ä¿é‡ˆã®å€ç‡è¨­å®š
const bail = document.getElementById('bailOption');
const bailMultiplier = (bail && bail.checked) ? 2 : 1;

// åˆè¨ˆåˆ‘æœŸï¼ˆä¿é‡ˆæ™‚ã¯0ï¼‰
if (bail && bail.checked) {
  time = 0;
  if (!selected.some(s => s.startsWith('â€»ä¿é‡ˆé‡‘é©ç”¨ä¸­'))) selected.push("â€»ä¿é‡ˆé‡‘é©ç”¨ä¸­ï¼ˆç½°é‡‘2å€ï¼‰");
}


// --- åˆè¨ˆè¨ˆç®— ---
let totalFineAll = 0;
if (people.length === 1) {
  // å˜ç‹¬ï¼šè–¬ã‚‚å«ã‚€å…¨éƒ¨
  totalFineAll = totalBeforeBail * bailMultiplier;
} else {
  // è¤‡æ•°äººï¼šéè–¬ç‰© + å„äººã®è–¬ç‰©åˆ†
  const allDrugFine = people.reduce((sum, p) => sum + (p.drugCount || 0) * drugUnitFinePer, 0);
  totalFineAll = (nonDrugBeforeBail + allDrugFine) * bailMultiplier;
}

// --- å„äººã®é‡‘é¡è¨ˆç®— ---
let peopleHtml = '';
if (people.length === 1) {
  peopleHtml = `${people[0].name}ï¼ˆè–¬Ã—${people[0].drugCount || 0}ï¼‰`;
} else {
  // ğŸ”½ ä¿®æ­£ï¼šäººæ•°ã§å‰²ã‚‰ãšã«ãã®ã¾ã¾éè–¬ç‰©ç½°é‡‘ã‚’ä½¿ã†
  const perPersonBase = Math.round(nonDrugBeforeBail);
  peopleHtml = people.map(p => {
    const baseName = `${p.name}ï¼ˆè–¬Ã—${p.drugCount || 0}ï¼‰`;
    const personDrugFine = (p.drugCount || 0) * drugUnitFinePer;
    const personTotal = Math.round((perPersonBase + personDrugFine) * bailMultiplier);
    return `${baseName}ã€€${personTotal.toLocaleString()} å††`;
  }).join('<br>');
}

// --- è¡¨ç¤º ---
const chargesHtml = selected.length
  ? selected.map(s => `ãƒ»${s}`).join('<br>')
  : '<span class="muted">ãªã—</span>';

const resultHtml =
  `<div><strong>åˆè¨ˆç½°é‡‘:</strong> ${totalFineAll.toLocaleString()} å††</div>` +
  `<div><strong>åˆè¨ˆåˆ‘æœŸ:</strong> ${time} åˆ†</div>` +
  `<div style="margin-top:8px"><strong>ç½ªçŠ¶:</strong><br>${chargesHtml}</div>` +
  `<div style="margin-top:8px"><strong>å¯¾è±¡è€…:</strong><br>${peopleHtml}</div>`;

const tools = `<div style="margin-top:8px"><button id="copyResult" class="small">åå‰ï¼‹ç½ªçŠ¶ã‚’ã‚³ãƒ”ãƒ¼</button></div>`;
const resEl = document.getElementById('result');
if (resEl) resEl.innerHTML = resultHtml + tools;



  const copyBtn = document.getElementById('copyResult');
  if (copyBtn) {
    copyBtn.onclick = () => {
      const selCharges = selected.filter(s => !s.startsWith('â€»')).map(s => s.replace(/^ãƒ»/, ''));
      const rows = Array.from(document.querySelectorAll('.person-row'));
      const peopleForCopy = participants.length ? participants.slice() : rows.map(r => {
        const id = r.getAttribute('data-id') || '';
        const name = r.querySelector('.person-name')?.textContent?.trim() || 'ï¼ˆç„¡åï¼‰';
        const drugInput = r.querySelector('input[id^="person_"]');
        const drugCount = drugInput ? (parseInt(drugInput.value, 10) || 0) : 0;
        return { id, name, drugCount };
      });

      const nameList = peopleForCopy.map(p => `${p.name}ï¼ˆè–¬Ã—${p.drugCount || 0}ï¼‰`);
      const namesStr = nameList.length ? nameList.join('ã€') : 'ï¼ˆãªã—ï¼‰';
      const chargesStr = selCharges.length
        ? selCharges.map((c, i) => (i === 0 ? c : 'ã€€ã€€ã€€' + c)).join('\n')
        : 'ï¼ˆãªã—ï¼‰';
      const text = `çŠ¯ç½ªè€…åï¼š${namesStr}\n\nç½ªçŠ¶ï¼š${chargesStr}`;

      console.log('COPY_TEXT:', text);
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(
          () => alert('åå‰ï¼‹ç½ªçŠ¶ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'),
          () => alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ')
        );
      } else {
        prompt('ä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', text);
      }
    };
  }
}

/* ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‰ */
document.addEventListener('DOMContentLoaded', ()=>{
  buildUI();
  renderParticipants();

  const gen = document.getElementById('generatedOptions');
  if(gen) gen.addEventListener('change', updateBailAvailability);

  const calcBtn = document.getElementById('calcBtn');
  if(calcBtn) calcBtn.addEventListener('click', calculateFine);

  const resetBtn = document.getElementById('resetBtn');
  if(resetBtn) resetBtn.addEventListener('click', ()=>{
    selectedCrime = null;
    const opt = document.getElementById('options');
    if(opt) opt.style.display='none';
    const res = document.getElementById('result');
    if(res) res.innerText='';
    document.querySelectorAll('.crime-btn').forEach(b=>b.classList.remove('active'));
    participants.length = 0;
    renderParticipants();
    updateGlobalDrugTotals();
  });

  const addPersonBtn = document.getElementById('addPersonBtn');
  if(addPersonBtn) addPersonBtn.addEventListener('click', ()=>{
    const nameInput = document.getElementById('personNameInput');
    const name = (nameInput.value || '').trim();
    if(!name) { alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    const id = Date.now().toString(36) + Math.random().toString(36).slice(2,6);
    participants.push({id, name, drugCount:0});
    nameInput.value = '';
    renderParticipants();
    updateGlobalDrugTotals();
  });

  const personNameInput = document.getElementById('personNameInput');
  if(personNameInput) personNameInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ e.preventDefault(); const btn = document.getElementById('addPersonBtn'); if(btn) btn.click(); }
  });
});
</script>
</body>
</html>
