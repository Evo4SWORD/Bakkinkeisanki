<!--修正済み
・中型犯罪であるアジト強盗を追加-->

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>罰金計算機（リファクタ版）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{ --gap:8px; --btn-radius:20px; --accent:#c00; --card-bg:#f7f7f7; --muted:#666; }
    body{font-family:Arial,Helvetica,sans-serif;padding:20px;background:#fff}
    .title-container{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    h1{margin:0;font-size:1.4rem}
    .title-note{color:var(--accent);font-weight:700;font-size:0.95rem}
    .controls{display:flex;flex-wrap:wrap;gap:var(--gap);margin-bottom:12px}
    .crime-btn{padding:8px 16px;border-radius:var(--btn-radius);border:1px solid #ddd;background:#fff;cursor:pointer}
    .crime-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    #options{display:none;margin-top:12px;background:var(--card-bg);padding:12px;border-radius:8px;border:1px solid #e0e0e0}
    fieldset{margin:10px 0;padding:10px;border:1px solid #ccc}
    legend{font-weight:700}
    .row{display:flex;align-items:center;gap:8px;margin:6px 0;flex-wrap:wrap;justify-content:space-between}
    .row-left{display:flex;align-items:center;gap:8px;min-width:0}
    .row-right{display:flex;align-items:center;gap:12px;white-space:nowrap;margin-left:12px}
    label{cursor:pointer;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    input[type=number]{width:68px;padding:4px}
    #result{margin-top:12px;padding:10px;border:1px solid #ccc;background:#fafafa}
    .muted{color:var(--muted);font-size:0.9rem}
    .meta{display:flex;align-items:center;color:var(--muted);font-size:0.9rem;min-width:160px;justify-content:flex-end}
    .amount{font-weight:700;font-family:Menlo,Monaco,Consolas,"Courier New",monospace;color:#000}
    .time{color:#444;margin-left:8px;font-size:0.9rem}
    .count-input{margin-left:6px}
    .right{margin-left:auto}
    button.small{padding:6px 10px;border-radius:6px;margin-right:6px}
    #personsContainer{margin-top:10px;border-top:1px solid #e5e5e5;padding-top:8px}
    .person-row{display:flex;align-items:center;gap:8px;margin:6px 0}
    .person-name{min-width:120px}
    .person-remove{background:#eee;border:1px solid #ccc;padding:4px 6px;border-radius:6px;cursor:pointer}
    @media (max-width:480px){
      .controls{gap:6px}.crime-btn{padding:6px 10px}
      .meta{font-size:0.85rem;min-width:120px}
      .row{flex-wrap:wrap}
      .row-right{margin-top:6px}
      .person-name{min-width:80px}
    }
  </style>
</head>
<body>
  <div class="title-container">
    <h1>罰金計算機</h1>
    <span class="title-note">※プレイヤー殺人罪は大型からチェック済み</span>
  </div>

  <div class="controls" id="crimeButtons" aria-label="犯罪一覧"></div>

  <div id="options" aria-live="polite">
    <div>
      <label><input type="checkbox" id="bailOption"> 保釈金支払い（罰金の2倍）<span class="muted">※軽犯罪のみ適用</span></label>
    </div>

    <div id="personsContainer">
      <div style="display:flex;gap:8px;align-items:center">
        <input type="text" id="personNameInput" placeholder="名前を入力" style="flex:1;padding:6px">
        <button id="addPersonBtn" class="crime-btn" type="button">追加</button>
      </div>
      <div id="personsList" aria-live="polite"></div>
      <div class="muted" style="font-size:0.85rem;margin-top:6px">複数追加できます。各人の「薬×」はコピー時に名前横に表示されます。</div>
    </div>

    <div id="generatedOptions"><!-- JS で生成されるオプション --></div>

    <div style="margin-top:10px">
      <button id="calcBtn" class="crime-btn">計算する</button>
      <button id="resetBtn" class="crime-btn">リセット</button>
    </div>
  </div>

  <div id="result" aria-live="polite"></div>

<script>
/* --- データ定義（省略せずそのまま） --- */
const DATA = {
  crimes: [
    "家強盗","ATM強盗","コンビニ強盗","アジト強盗","フリーカ銀行強盗","宝石強盗","軍事物資強盗",
    "パレト銀行強盗","客船強盗","ボブキャット","飛行場襲撃","アーティファクト強盗",
    "ユニオン銀行強盗","パシフィック銀行強盗","ファストヘイスト","個人医","その他"
  ],
  fixedTimeByCrime: {
    "家強盗":20,"ATM強盗":20,"コンビニ強盗":20,"フリーカ銀行強盗":30,"宝石強盗":30,"アジト強盗":30,
    "軍事物資強盗":30,"パレト銀行強盗":40,"客船強盗":40,"ボブキャット":40,
    "飛行場襲撃":60,"アーティファクト強盗":60,"ユニオン銀行強盗":60,
    "パシフィック銀行強盗":60,"ファストヘイスト":60,"個人医":30
  },
  charges: [
    { id:"gunLaw", label:"銃刀法違反", fine:100000, time:10, group:"petty" },
    { id:"theft", label:"軽窃盗罪", fine:300000, time:10, group:"petty" },
    { id:"pettyRobberyAttempt", label:"軽強盗未遂", fine:150000, time:0, group:"petty" },
    { id:"pettyRobbery", label:"軽強盗罪", fine:300000, time:0, group:"petty" },
    { id:"fraud", label:"詐欺罪", fine:500000, time:10, group:"petty" },
    { id:"obstructionOfficialDuties", label:"公務執行妨害", fine:100000, time:10, group:"petty" },
    { id:"assault", label:"暴行罪", fine:200000, time:10, group:"petty" },
    { id:"noId", label:"ID・ライセンス不携帯", fine:100000, time:0, group:"petty" },

    { id:"aggravatedTheft", label:"重窃盗罪（公務員車両）", fine:3000000, time:30, group:"heavy" },
    { id:"aggravatedRobberyAttempt", label:"準重強盗未遂", fine:500000, time:0, group:"heavy" },
    { id:"aggravatedRobbery", label:"準重強盗罪", fine:1000000, time:0, group:"heavy" },
    { id:"armedRobberyAttempt", label:"重強盗未遂", fine:3000000, time:0, group:"heavy" },
    { id:"armedRobbery", label:"重強盗罪", fine:6000000, time:0, group:"heavy" },
    { id:"firstDegreeRobberyAttempt", label:"最重強盗未遂", fine:7000000, time:0, group:"heavy" },
    { id:"firstDegreeRobbery", label:"最重強盗罪", fine:14000000, time:0, group:"heavy" },
    { id:"kidnap", label:"誘拐・拉致・監禁罪", fine:100000, time:10, group:"heavy" },
    { id:"npcMurder", label:"NPC殺人罪", fine:100000, time:10, group:"heavy" },
    { id:"attemptedMurder", label:"殺人未遂", fine:1000000, time:20, group:"heavy" },
    { id:"playerMurder", label:"プレイヤー殺人罪", fine:1500000, time:30, group:"heavy" },
    { id:"prisonEscape", label:"脱獄罪", fine:1000000, time:60, group:"heavy" },
    { id:"aidingEscape", label:"逃走補助罪", fine:2000000, time:30, group:"heavy" },
    { id:"facilityAttack", label:"公共施設襲撃罪", fine:50000000, time:60, group:"heavy" },
    { id:"PoliceStationAssault", label:"警察署襲撃罪", fine:30000000, time:60, group:"heavy" },
    { id:"eventTerrorism", label:"イベントテロ罪", fine:100000000, time:60, group:"heavy" },
    { id:"sexualHarassment", label:"セクハラ罪", fine:100000000, time:60, group:"heavy" },
    { id:"bribery", label:"収賄罪", fine:300000000, time:60, group:"heavy" },
    { id:"businessObstruction", label:"業務妨害罪", fine:5000000, time:60, group:"heavy" },

    { id:"illegalDrugHarvesting", label:"違法薬物採取", fine:500000, time:10, group:"drug" },
    { id:"illegalRawDrug", label:"違法薬物原材料所持（1個 1万）", finePerUnit:10000, time:20, group:"drug", hasCount:true, max:999 },
    { id:"illegalDrugUnit", label:"違法薬物所持（1個 2万）", finePerUnit:20000, time:20, group:"drug", hasCount:true, max:999 },
    { id:"illegalDrugFlat", label:"違法薬物売買", fine:200000, time:20, group:"drug" },

    {id: "personalMedicalImpound", label: "個人医車両インパウンド代", fine: 1000000, time: 0, group: "special", noBail: true }
  ],
  crimeMappings: {
    "家強盗":["pettyRobbery","obstructionOfficialDuties"],
    "ATM強盗":["pettyRobbery","obstructionOfficialDuties"],
    "コンビニ強盗":["pettyRobbery","gunLaw","obstructionOfficialDuties","kidnap","npcMurder"],
    "フリーカ銀行強盗":["aggravatedRobbery","gunLaw","obstructionOfficialDuties","kidnap"],
    "宝石強盗":["aggravatedRobbery","gunLaw","obstructionOfficialDuties","kidnap"],
    "アジト強盗":["aggravatedRobbery","gunLaw","theft","obstructionOfficialDuties","kidnap","npcMurder"],
    "軍事物資強盗":["aggravatedRobbery","gunLaw","obstructionOfficialDuties","npcMurder","playerMurder",],
    "パレト銀行強盗":["armedRobbery","gunLaw","obstructionOfficialDuties","playerMurder"],
    "客船強盗":["armedRobbery","gunLaw","obstructionOfficialDuties","npcMurder","playerMurder"],
    "ボブキャット":["armedRobbery","gunLaw","obstructionOfficialDuties","npcMurder","playerMurder"],
    "飛行場襲撃":["firstDegreeRobbery","gunLaw","npcMurder","obstructionOfficialDuties","playerMurder"],
    "アーティファクト強盗":["firstDegreeRobbery","gunLaw","obstructionOfficialDuties","npcMurder","playerMurder"],
    "ユニオン銀行強盗":["firstDegreeRobbery","gunLaw","obstructionOfficialDuties","playerMurder"],
    "パシフィック銀行強盗":["firstDegreeRobbery","gunLaw","obstructionOfficialDuties","playerMurder"],
    "ファストヘイスト":["firstDegreeRobbery","gunLaw","obstructionOfficialDuties","playerMurder"],
    "個人医":["aidingEscape","obstructionOfficialDuties","personalMedicalImpound"]
  }
};

/* ヘルパー */
function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==='class') e.className = v;
    else if(k==='html') e.innerHTML = v;
    else e.setAttribute(k,v);
  });
  children.forEach(c=>{ if(c!=null) e.append(typeof c==='string'?document.createTextNode(c):c); });
  return e;
}

/* participants */
const participants = []; // {id, name, drugCount}

/* participants→生成オプションを更新（名前側の薬数を下の違法薬物所持に反映） */
function updateGlobalDrugTotals(){
  const total = participants.reduce((s,p) => s + (p.drugCount || 0), 0);
  const unitCb = document.getElementById('illegalDrugUnit');
  const unitCount = document.getElementById('illegalDrugUnit_count');
  if(!unitCb || !unitCount) return;

  if(participants.length > 0){
    if(total > 0){
      unitCb.checked = true;
      unitCount.value = total;
      unitCount.style.display = 'inline-block';
    } else {
      unitCb.checked = false;
      unitCount.style.display = 'none';
    }
  } else {
    unitCount.style.display = unitCb.checked ? 'inline-block' : 'none';
  }
}

/* UI の生成 */
function buildUI() {
  // ===== 犯罪ボタン生成 =====
  const btnContainer = document.getElementById('crimeButtons');
  btnContainer.innerHTML = '';

  DATA.crimes.forEach(name => {
    const b = el('button', {
      class: 'crime-btn',
      type: 'button'
    });

    b.textContent = name;
    b.addEventListener('click', () => selectCrime(name, b));
    btnContainer.appendChild(b);
  });

  // ===== 罪状オプション生成 =====
  const gen = document.getElementById('generatedOptions');
  if (!gen) return;
  gen.innerHTML = '';

  const groups = { petty: [], heavy: [], drug: [], special: [] };
  DATA.charges.forEach(ch => groups[ch.group || 'petty'].push(ch));

  Object.entries(groups).forEach(([groupName, list]) => {
    const fs = el(
      'fieldset',
      {},
      el(
        'legend',
        {},
        groupName === 'petty'
          ? '軽犯罪'
          : groupName === 'heavy'
          ? '重犯罪'
          : groupName === 'drug'
          ? '薬'
          : '特殊'
      )
    );

    list.forEach(ch => {
      const row = el('div', { class: 'row' });

      const checkbox = el('input', { type: 'checkbox', id: ch.id });
      const label = el('label', { for: ch.id }, ch.label);
      const left = el('div', { class: 'row-left' });
      left.appendChild(checkbox);
      left.appendChild(label);

      if (ch.hasCount) {
        const maxVal = ch.group === 'drug' ? 100 : ch.max || 999;
        const num = el('input', {
          type: 'number',
          id: ch.id + '_count',
          value: 0,
          min: 0,
          max: maxVal,
          class: 'count-input',
          style: 'display:none;margin-left:6px'
        });

        checkbox.addEventListener(
          'change',
          () => (num.style.display = checkbox.checked ? 'inline-block' : 'none')
        );

        num.addEventListener('input', e => {
          let v = parseInt(e.target.value, 10);
          if (Number.isNaN(v)) v = 0;
          if (v < 0) v = 0;
          if (v > maxVal) v = maxVal;
          e.target.value = v;
        });

        left.appendChild(num);
      }

      row.appendChild(left);

      const right = el('div', { class: 'row-right' });
      const amountText = ch.hasCount ? ch.finePerUnit || 0 : ch.fine || 0;

      const amount = el('span', { class: 'meta' });
      amount.appendChild(
        el('span', { class: 'amount' }, amountText.toLocaleString() + ' 円')
      );
      amount.appendChild(
        el('span', { class: 'time' }, (ch.time || 0) + ' 分')
      );

      right.appendChild(amount);
      row.appendChild(right);

      fs.appendChild(row);
    });

    gen.appendChild(fs);
  });
}


/* participants UI helpers */
function renderParticipants(){
  const list = document.getElementById('personsList');
  if(!list) return;
  list.innerHTML = '';
  participants.forEach(p=>{
    const row = el('div',{class:'person-row', 'data-id':p.id});
    const nameSpan = el('span',{class:'person-name'}, p.name);

    const drugLabel = el('label',{}, `（薬×`);
    const drugInput = el('input',{
      type:'number',
      value:p.drugCount,
      min:0,
      max:100,
      style:'width:72px',
      id:`person_${p.id}_drug`
    });

    drugInput.addEventListener('change', (e)=> {
      let val = parseInt(e.target.value,10) || 0;
      if (val > 100) {
        val = 100;
        e.target.value = 100;
      }
      p.drugCount = val;
      updateGlobalDrugTotals();
    });

    const drugClose = el('span',{}, '個）');
    const removeBtn = el('button',{class:'person-remove',type:'button'}, '削除');
    removeBtn.addEventListener('click', ()=> {
      const idx = participants.findIndex(x=>x.id===p.id);
      if(idx>-1) participants.splice(idx,1);
      renderParticipants();
      updateGlobalDrugTotals();
    });

    row.appendChild(nameSpan);
    row.appendChild(drugLabel);
    row.appendChild(drugInput);
    row.appendChild(drugClose);
    row.appendChild(removeBtn);
    list.appendChild(row);
  });

  updateGlobalDrugTotals();
}

/* 選択・表示制御 */
let selectedCrime = null;
function selectCrime(name, btn){
  const optionsDiv = document.getElementById('options');
  const allButtons = document.querySelectorAll('.crime-btn');

  const impound = document.getElementById('personalMedicalImpound');
  const impoundRow = impound?.closest('.row');

  if(selectedCrime === name && optionsDiv.style.display === 'block'){
    optionsDiv.style.display = 'none';
    document.getElementById('result').innerText = '';
    allButtons.forEach(b=>b.classList.remove('active'));
    selectedCrime = null;
    return;
  }

  selectedCrime = name;
  allButtons.forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('result').innerText = '';
  optionsDiv.style.display = 'block';

  document.querySelectorAll('#generatedOptions input[type=checkbox]')
    .forEach(cb=>cb.checked=false);
  document.querySelectorAll('#generatedOptions input[type=number]')
    .forEach(n=>{ n.value=0; n.style.display='none'; });

  const map = DATA.crimeMappings[name];
  if(map){
    map.forEach(id=>{
      const elm = document.getElementById(id);
      if(elm) elm.checked = true;
      const c = document.getElementById(id + '_count');
      if(c) c.style.display = elm && elm.checked ? 'inline-block' : 'none';
    });
  }


  if (impoundRow) {
    if (name === '個人医') {
      impoundRow.style.display = '';
    } else {
      impoundRow.style.display = 'none';
      impound.checked = false;
    }
  }

  updateBailAvailability();
}



/* 保釈判定 */
function updateBailAvailability(){
  const bailEl = document.getElementById('bailOption');
  if(!bailEl) return;
  const heavyIds = DATA.charges.filter(c=>c.group==='heavy').map(c=>c.id);
  const heavyChecked = heavyIds.some(id => {
    const el = document.getElementById(id);
    return el && el.checked;
  });
  const existingWarn = document.getElementById('bailWarning');
  if(heavyChecked){
    bailEl.checked = false;
    bailEl.disabled = true;
    if(!existingWarn){
      const warn = el('div',{id:'bailWarning',style:'color:var(--accent)'}, '※保釈金は軽犯罪にしか適用できません。');
      bailEl.parentElement.appendChild(warn);
    }
  } else {
    bailEl.disabled = false;
    if(existingWarn) existingWarn.remove();
  }
}

/* 計算ロジック（修正版：一貫した変数と分岐） */
function calculateFine(){
  // 入力中の名前を計算時に自動追加（重複は防止）
  const nameInput = document.getElementById('personNameInput');
  const typedName = nameInput?.value?.trim();
  if(typedName){
    const exists = participants.some(p => p.name === typedName);
    if(!exists){
      const id = Date.now().toString(36) + Math.random().toString(36).slice(2,6);
      participants.push({ id, name: typedName, drugCount: 0 });
      renderParticipants();
    }
    nameInput.value = '';
  }

  updateGlobalDrugTotals();
  updateBailAvailability();

  // --- 基本集計（薬はまだ totalBeforeBail に含めない） ---
  let totalBeforeBail = 0;
  let noBailFine = 0;
  let time = 0;
  const selected = [];
  const breakdown = {petty: {fine:0, time:0}, heavy:{fine:0,time:0}, drug:{fine:0,time:0}, special:{fine:0,time:0}};

  const isManual = selectedCrime === 'その他';
  if(!isManual && DATA.fixedTimeByCrime[selectedCrime]) time = DATA.fixedTimeByCrime[selectedCrime];

  // 参加者一覧取得
  const personRows = Array.from(document.querySelectorAll('.person-row'));
  const people = participants.length ? participants.slice() : personRows.map(r => {
    const id = r.getAttribute('data-id') || '';
    const name = r.querySelector('.person-name')?.textContent?.trim() || '（無名）';
    const drugInput = r.querySelector('input[id^="person_"]');
    const drugCount = drugInput ? (parseInt(drugInput.value, 10) || 0) : 0;
    return { id, name, drugCount };
  });
  const participantsDrugTotal = people.reduce((s,p)=> s + (p.drugCount||0), 0);

  // charges を集計（薬は人ベースならここではカウントしない）
  DATA.charges.forEach(ch=>{
    const cb = document.getElementById(ch.id);
    if (!cb || !cb.checked) return;

// nobail の罪状は別枠で加算
if (ch.noBail) {
  noBailFine += ch.fine || 0;
  selected.push(ch.label);
  return;
}

if (ch.hasCount) {
  // 名前が存在する場合は個人側の drugCount を優先するのでここでの数値カウントをスキップ
  if (ch.group === 'drug' && people.length > 0) {
    return;
  }
  const cnt =
    parseInt(document.getElementById(ch.id + '_count')?.value, 10) || 0;
  const add = (ch.finePerUnit || 0) * cnt;
  totalBeforeBail += add;
  breakdown[ch.group].fine += add;
  breakdown[ch.group].time += ch.time || 0;
  if (ch.group === 'drug') breakdown.drug.fine += add;
  if (isManual) time += ch.time || 0;
} else {
  const add = ch.fine || 0;
  totalBeforeBail += add;
  breakdown[ch.group].fine += add;
  breakdown[ch.group].time += ch.time || 0;
  if (isManual) time += ch.time || 0;
  selected.push(ch.label);
}

  });

  // 違法薬物所持の総数表示（UI用）
  if(participantsDrugTotal > 0){
    selected.push(`違法薬物所持（${participantsDrugTotal}個）※総数`);
  }

  // --- 薬関係（単価はここで一度だけ） ---
  const drugUnitFinePer = 20000; // illegalDrugUnit の単価
  const participantsDrugFine = participantsDrugTotal * drugUnitFinePer;

  // 非薬物部分（合計に含めるベース）
  const nonDrugBeforeBail = totalBeforeBail; // totalBeforeBail は今薬を含まないように構成している

  // 保釈処理（罰金倍率と刑期の扱い）
  const bailEl = document.getElementById('bailOption');
  const bailMultiplier = (bailEl && bailEl.checked) ? 2 : 1;
  // 保釈非対象の罰金（個人医車両インパウンド代など）
  if (bailEl && bailEl.checked) {
    time = 0;
    if (!selected.some(s => s.startsWith('※保釈金適用中'))) {
      selected.push("※保釈金適用中（罰金2倍）");
    }
  }

  // --- 最終合計の決定（あなたの要望通り） ---
  // 単独（1名）: 合計にその人の薬代を含める
  // 複数人: 合計は非薬物のみ（薬は個別表示）
  let totalFineAll = 0;
 if (people.length === 1) {
  // 単独：非薬物 + その人の薬代 → 保釈倍率 → nobail加算
  const singleDrugFine =
    (people[0].drugCount || 0) * drugUnitFinePer;
  totalFineAll =
    Math.round(
      (nonDrugBeforeBail + singleDrugFine) * bailMultiplier
    ) +
    noBailFine;
} else {
  // 複数人：非薬物のみ → 保釈倍率 → nobail加算
  totalFineAll =
    Math.round(nonDrugBeforeBail * bailMultiplier) +
    noBailFine;
}


  // --- 各人の表示（複数人時は非薬物を人数で割らず表示／合算しない設計） ---
  let peopleHtml = '';
  if (people.length === 1) {
    // 1人は名前表示のみ（合計に薬込みのため個別額はトップに出す）
    peopleHtml = `${people[0].name}（薬×${people[0].drugCount || 0}）`;
  } else if (people.length > 1) {
    // 複数人：非薬物ベース（全体）をそのまま各行に表示し、個人の薬代は追加表示
    // ※要望どおり「人数で割らない」ので perPersonBase = nonDrugBeforeBail
    const perPersonBase = nonDrugBeforeBail;
    peopleHtml = people.map(p => {
      const baseName = `${p.name}（薬×${p.drugCount || 0}）`;
      const personDrugFine = (p.drugCount || 0) * drugUnitFinePer;
      const personTotal = Math.round((perPersonBase + personDrugFine) * bailMultiplier);
      return `${baseName}　${personTotal.toLocaleString()} 円`;
    }).join('<br>');
  } else {
    peopleHtml = '<span class="muted">なし</span>';
  }

  // --- 罪状表示 ---
  const chargesHtml = selected.length
    ? selected.map(s => `・${s}`).join('<br>')
    : '<span class="muted">なし</span>';

  // --- 出力 ---
  const resultHtml =
    `<div><strong>合計罰金:</strong> ${totalFineAll.toLocaleString()} 円</div>` +
    `<div><strong>合計刑期:</strong> ${time} 分</div>` +
    `<div style="margin-top:8px"><strong>罪状:</strong><br>${chargesHtml}</div>` +
    `<div style="margin-top:8px"><strong>対象者:</strong><br>${peopleHtml}</div>`;

  const tools = `<div style="margin-top:8px"><button id="copyResult" class="small">名前＋罪状をコピー</button></div>`;
  const resEl = document.getElementById('result');
  if (resEl) resEl.innerHTML = resultHtml + tools;

  // コピー処理
  const copyBtn = document.getElementById('copyResult');
  if (copyBtn) {
    copyBtn.onclick = () => {
      const selCharges = selected.filter(s => !s.startsWith('※')).map(s => s.replace(/^・/, ''));
      const peopleForCopy = people;
      const nameList = peopleForCopy.map(p => `${p.name}（薬×${p.drugCount || 0}）`);
      const namesStr = nameList.length ? nameList.join('、') : '（なし）';
      const chargesStr = selCharges.length
        ? selCharges.map((c, i) => (i === 0 ? c : '　　　' + c)).join('\n')
        : '（なし）';
      const text = `犯罪者名：${namesStr}\n\n罪状：${chargesStr}`;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(
          () => alert('名前＋罪状をコピーしました'),
          () => alert('コピーに失敗しました')
        );
      } else {
        prompt('以下をコピーしてください', text);
      }
    };
  }
}

/* イベントバインド */
document.addEventListener('DOMContentLoaded', ()=>{
  buildUI();
  renderParticipants();

  const gen = document.getElementById('generatedOptions');
  if(gen) gen.addEventListener('change', updateBailAvailability);

  const calcBtn = document.getElementById('calcBtn');
  if(calcBtn) calcBtn.addEventListener('click', calculateFine);

  const resetBtn = document.getElementById('resetBtn');
  if(resetBtn) resetBtn.addEventListener('click', ()=>{
    selectedCrime = null;
    const opt = document.getElementById('options');
    if(opt) opt.style.display='none';
    const res = document.getElementById('result');
    if(res) res.innerText='';
    document.querySelectorAll('.crime-btn').forEach(b=>b.classList.remove('active'));
    participants.length = 0;
    renderParticipants();
    updateGlobalDrugTotals();
  });

  const addPersonBtn = document.getElementById('addPersonBtn');
  if(addPersonBtn) addPersonBtn.addEventListener('click', ()=>{
    const nameInput = document.getElementById('personNameInput');
    const name = (nameInput.value || '').trim();
    if(!name) { alert('名前を入力してください'); return; }
    const id = Date.now().toString(36) + Math.random().toString(36).slice(2,6);
    participants.push({id, name, drugCount:0});
    nameInput.value = '';
    renderParticipants();
    updateGlobalDrugTotals();
  });

  const personNameInput = document.getElementById('personNameInput');
  if(personNameInput) personNameInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ e.preventDefault(); const btn = document.getElementById('addPersonBtn'); if(btn) btn.click(); }
  });
});
</script>
</body>
</html>
